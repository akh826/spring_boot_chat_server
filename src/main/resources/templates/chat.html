<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Room</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        margin: 0;
        padding: 0;
        height: 100%;
      }
      .chat-container {
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
        bottom: 10px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
      }
      .chat-header {
        position: sticky;
        top: 0;
        z-index: 2;
        padding: 16px;
        background: #007bff;
        color: #fff;
        border-radius: 8px 8px 0 0;
      }
      .chat-messages {
        flex: 1 1 auto;
        overflow-y: auto;
        padding: 16px;
        border-bottom: 1px solid #eee;
        margin-bottom: 64px; /* Space for input area */
      }
      .chat-message {
        margin-bottom: 12px;
      }
      .chat-message .user {
        color: rgb(255, 0, 0);
        font-weight: bold;
        margin-right: 8px;
      }
      .chat-message .robot {
        color: #007bff;
        font-weight: bold;
        margin-right: 8px;
      }
      .chat-input-area {
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: 10px;
        background: #fff;
        display: flex;
        padding: 16px;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.03);
        z-index: 2;
      }
      .chat-input-area input[type="text"] {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      .chat-input-area button {
        margin-left: 8px;
        padding: 10px 20px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .chat-input-area button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div
        class="chat-header"
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <h2 style="margin: 0">
          ChatBot (<span th:text="${ModelName}"></span>)
        </h2>
        <button
          id="clearHistoryBtn"
          style="
            background: #fff;
            color: rgb(255, 0, 0);
            border: none;
            border-radius: 4px;
            padding: 8px 16px;
            font-weight: bold;
            cursor: pointer;
          "
        >
          Clear History
        </button>
      </div>
      <div class="chat-messages" id="chatMessages">
        <!-- Messages will appear here -->
      </div>
      <form class="chat-input-area" id="chatForm" autocomplete="off">
        <textarea
          id="userInput"
          placeholder="Type your message..."
          required
          rows="2"
          style="
            resize: none;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
          "
        ></textarea>
        <button type="submit">Send</button>
      </form>
    </div>
    <script>
      // Store chat history as an array of {role, content}
      const chatHistory = [];
      const chatForm = document.getElementById("chatForm");
      const chatMessages = document.getElementById("chatMessages");
      const userInput = document.getElementById("userInput");

      let waitingForResponse = false;

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function appendMessage(role, text) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "chat-message";
        const safeText = escapeHtml(text).replace(/\n/g, "<br>");
        if (role === "user") {
          msgDiv.innerHTML = `<span class="user">You:</span> <br /><span class="text">${safeText}</span>`;
        } else if (role === "robot") {
          msgDiv.innerHTML = `<span class="robot">Robot:</span> <br /><span class="text">${safeText}</span>`;
        }
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Allow Shift+Enter for newline, Enter for send
      userInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(
            new Event("submit", { cancelable: true, bubbles: true })
          );
        }
        // If Shift+Enter, allow default (newline)
      });

      chatForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (waitingForResponse) return; // Prevent sending if waiting for response

        const message = userInput.value.trim();
        if (message) {
          waitingForResponse = true;
          userInput.disabled = true;

          // Add user message to history and UI
          chatHistory.push({ role: "user", content: message });
          appendMessage("user", message);
          userInput.value = "";

          // Show robot is typing...
          const typingDiv = document.createElement("div");
          typingDiv.className = "chat-message";
          typingDiv.id = "robot-typing";
          typingDiv.innerHTML = `<span class="robot">Robot:</span> <span class="text">...</span>`;
          chatMessages.appendChild(typingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          // Send POST request with chat history
          fetch("/postchat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ history: chatHistory }),
          })
            .then((response) => response.json())
            .then((data) => {
              // Remove typing indicator
              const typingElem = document.getElementById("robot-typing");
              if (typingElem) typingElem.remove();

              // Add robot reply to history and UI
              if (data && data.reply) {
                chatHistory.push({ role: "assistant", content: data.reply });
                appendMessage("robot", data.reply);
              } else {
                appendMessage("robot", "No reply from server.");
              }
            })
            .catch(() => {
              const typingElem = document.getElementById("robot-typing");
              if (typingElem) typingElem.remove();
              appendMessage("robot", "Error contacting server.");
            })
            .finally(() => {
              waitingForResponse = false;
              userInput.disabled = false;
              userInput.focus();
            });
        }
      });

      document.getElementById("clearHistoryBtn").onclick = function () {
        chatHistory.length = 0; // Clear array
        chatMessages.innerHTML = ""; // Clear UI
        userInput.value = "";
        userInput.focus();
      };
    </script>
  </body>
</html>
