<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Chat Room</title>
    <link rel="stylesheet" href="/css/chat.css" />
  </head>
  <body>
    <th:block th:replace="~{TopNav.html}"></th:block>
    <div class="chat-container">
      <div
        class="chat-header"
        style="
          display: flex;
          align-items: center;
          justify-content: space-between;
        "
      >
        <h2 style="margin: 0; font-size: 1.3em;">
          ChatBot (<span th:text="${ModelName}"></span>)
        </h2>
        <div style="display: flex; gap: 8px;">
          <button
            id="settingsBtn"
            style="
              background: #fff;
              color: #007bff;
              border: none;
              border-radius: 4px;
              padding: 8px 12px;
              font-weight: bold;
              cursor: pointer;
              -webkit-tap-highlight-color: rgba(0, 123, 255, 0.3);
              touch-action: manipulation;
              pointer-events: auto;
              min-height: 44px;
              min-width: 44px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <img
              src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/gear.svg"
              alt="Settings"
              style="width: 18px; height: 18px; display: block; pointer-events: none;"
            />
          </button>
          <button
            id="clearHistoryBtn"
            style="
              background: #fff;
              color: rgb(255, 0, 0);
              border: none;
              border-radius: 4px;
              padding: 8px 12px;
              font-weight: bold;
              cursor: pointer;
              -webkit-tap-highlight-color: rgba(255, 0, 0, 0.3);
              touch-action: manipulation;
              pointer-events: auto;
              min-height: 44px;
              min-width: 44px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            <img
              src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/icons/trash.svg"
              alt="Clear History"
              style="
                width: 18px;
                height: 18px;
                display: block;
                pointer-events: none;
                filter: invert(22%) sepia(99%) saturate(7482%)
                  hue-rotate(357deg) brightness(97%) contrast(119%);
              "
            />
          </button>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages">
        <!-- Messages will appear here -->
      </div>
      <form class="chat-input-area" id="chatForm" autocomplete="off">
        <textarea
          id="userInput"
          placeholder="Type your message..."
          required
          rows="1"
          style="
            border: 1px solid #ccc;
            border-radius: 20px;
            padding: 12px 16px;
            font-size: 16px;
            line-height: 1.4;
            resize: none;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
          "
        ></textarea>
        <button type="submit" id="sendButton">Send</button>
      </form>
    </div>
    <script>
      // iOS Safari detection
      const isIOSSafari = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      
      // Prevent accidental page refresh
      window.addEventListener('beforeunload', function (e) {
        if (chatHistory.length > 0) {
          e.preventDefault();
          e.returnValue = 'Are you sure you want to leave? Your chat history will be lost.';
          return 'Are you sure you want to leave? Your chat history will be lost.';
        }
      });

      // iOS-specific fixes
      if (isIOSSafari) {
        // Fix viewport height issues on iOS
        function setViewportHeight() {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        
        setViewportHeight();
        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', function() {
          setTimeout(setViewportHeight, 500);
        });

        // Prevent iOS bounce scrolling
        document.addEventListener('touchmove', function(e) {
          e.preventDefault();
        }, { passive: false });

        // Allow scrolling only in chat messages area
        const chatMessagesEl = document.getElementById('chatMessages');
        if (chatMessagesEl) {
          chatMessagesEl.addEventListener('touchmove', function(e) {
            e.stopPropagation();
          }, { passive: true });
        }

        // Fix input focus issues on iOS
        document.addEventListener('touchend', function(e) {
          if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
            e.target.focus();
          }
        });
      } else {
        // Prevent pull-to-refresh on other mobile browsers
        document.body.addEventListener('touchstart', function(e) {
          if (e.touches.length === 1 && window.pageYOffset === 0) {
            e.preventDefault();
          }
        }, { passive: false });

        document.body.addEventListener('touchmove', function(e) {
          if (e.touches.length === 1 && window.pageYOffset === 0) {
            e.preventDefault();
          }
        }, { passive: false });
      }

      // Auto-resize textarea
      function autoResize(textarea) {
        textarea.style.height = 'auto';
        const maxHeight = isIOSSafari ? 120 : 100; // More space on iOS
        if (textarea.scrollHeight <= maxHeight) {
          textarea.style.height = textarea.scrollHeight + 'px';
        } else {
          textarea.style.height = maxHeight + 'px';
        }
      }

      // Store chat history as an array of {role, content}
      const chatHistory = [];
      const chatForm = document.getElementById("chatForm");
      const chatMessages = document.getElementById("chatMessages");
      const userInput = document.getElementById("userInput");
      const sendButton = document.getElementById("sendButton");

      let waitingForResponse = false;

      // Auto-resize textarea on input
      userInput.addEventListener('input', function() {
        autoResize(this);
      });

      // Handle viewport changes (mobile keyboard)
      function handleViewportChange() {
        const viewportHeight = window.visualViewport ? window.visualViewport.height : window.innerHeight;
        document.documentElement.style.setProperty('--viewport-height', `${viewportHeight}px`);
        
        // Scroll to bottom when keyboard opens/closes
        setTimeout(() => {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
      }

      if (window.visualViewport) {
        window.visualViewport.addEventListener('resize', handleViewportChange);
      }
      window.addEventListener('resize', handleViewportChange);
      handleViewportChange();

      function escapeHtml(text) {
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }

      function appendMessage(role, text) {
        const msgDiv = document.createElement("div");
        msgDiv.className = "chat-message";
        if (role === "user") {
          // Escape HTML and preserve newlines for user messages
          let safeText = escapeHtml(text).replace(/\n/g, "<br>");
          msgDiv.innerHTML = `<span class="user">You:</span> <br /><span class="text">${safeText}</span>`;
        } else if (role === "robot") {
          // Render Markdown for robot messages
          let html = marked.parse(text);
          msgDiv.innerHTML = `<span class="robot">Robot:</span> <br /><span class="text">${html}</span>`;
        }
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Allow Shift+Enter for newline, Enter for send
      userInput.addEventListener("keydown", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          chatForm.dispatchEvent(
            new Event("submit", { cancelable: true, bubbles: true })
          );
        }
        // If Shift+Enter, allow default (newline)
      });

      chatForm.addEventListener("submit", function (e) {
        e.preventDefault();
        if (waitingForResponse) return; // Prevent sending if waiting for response

        const message = userInput.value.trim();
        if (message) {
          waitingForResponse = true;
          userInput.disabled = true;
          sendButton.disabled = true;
          sendButton.textContent = "...";

          // Add user message to history and UI
          chatHistory.push({ role: "user", content: message });
          appendMessage("user", message);
          userInput.value = "";
          autoResize(userInput); // Reset textarea height

          // Show robot is typing...
          const typingDiv = document.createElement("div");
          typingDiv.className = "chat-message";
          typingDiv.id = "robot-typing";
          typingDiv.innerHTML = `<span class="robot">Robot:</span> <span class="text">...</span>`;
          chatMessages.appendChild(typingDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight;

          const systemPrompt = {
            role: "system",
            content: localStorage.getItem("deepseek_system_prompt") || "",
          };
          const chatWithSystemPrompt = [systemPrompt, ...chatHistory];

          // Send POST request with chat history
          fetch("/postchat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              history: chatWithSystemPrompt,
              deepseek_api_key: localStorage.getItem("deepseek_api_key") || "",
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              // Remove typing indicator
              const typingElem = document.getElementById("robot-typing");
              if (typingElem) typingElem.remove();

              // Add robot reply to history and UI
              if (data && data.reply) {
                chatHistory.push({ role: "assistant", content: data.reply });
                appendMessage("robot", data.reply);
              } else {
                appendMessage("robot", "No reply from server.");
              }
            })
            .catch(() => {
              const typingElem = document.getElementById("robot-typing");
              if (typingElem) typingElem.remove();
              appendMessage("robot", "Error contacting server.");
            })
            .finally(() => {
              waitingForResponse = false;
              userInput.disabled = false;
              sendButton.disabled = false;
              sendButton.textContent = "Send";
              userInput.focus();
            });
        }
      });
      document.getElementById("settingsBtn").onclick = function () {
        // Create overlay
        const overlay = document.createElement("div");
        overlay.style.position = "fixed";
        overlay.style.top = 0;
        overlay.style.left = 0;
        overlay.style.width = "100vw";
        overlay.style.height = "100vh";
        overlay.style.background = "rgba(0,0,0,0.3)";
        overlay.style.zIndex = 1000;
        overlay.id = "settingsOverlay";

        // Create iframe container
        const frameContainer = document.createElement("div");
        frameContainer.style.position = "absolute";
        frameContainer.style.top = "50%";
        frameContainer.style.left = "50%";
        frameContainer.style.transform = "translate(-50%, -50%)";
        frameContainer.style.background = "#fff";
        frameContainer.style.borderRadius = "8px";
        frameContainer.style.boxShadow = "0 2px 16px rgba(0,0,0,0.2)";
        frameContainer.style.width = "90vw";
        frameContainer.style.maxWidth = "600px";
        frameContainer.style.height = "80vh";
        frameContainer.style.display = "flex";
        frameContainer.style.flexDirection = "column";
        frameContainer.style.overflow = "hidden";

        // Close button
        const closeBtn = document.createElement("button");
        closeBtn.title = "Close";
        closeBtn.style.alignSelf = "flex-end";
        closeBtn.style.margin = "8px";
        closeBtn.style.background = "transparent";
        closeBtn.style.color = "#dc3545";
        closeBtn.style.border = "none";
        closeBtn.style.borderRadius = "50%";
        closeBtn.style.padding = "4px";
        closeBtn.style.cursor = "pointer";
        closeBtn.style.width = "32px";
        closeBtn.style.height = "32px";
        closeBtn.style.display = "flex";
        closeBtn.style.alignItems = "center";
        closeBtn.style.justifyContent = "center";
        // Red cross SVG
        closeBtn.innerHTML = `<svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
  <line x1="5" y1="5" x2="15" y2="15" stroke="#dc3545" stroke-width="2" stroke-linecap="round"/>
  <line x1="15" y1="5" x2="5" y2="15" stroke="#dc3545" stroke-width="2" stroke-linecap="round"/>
</svg>`;
        closeBtn.onclick = function () {
          document.body.removeChild(overlay);
        };

        // Iframe
        const iframe = document.createElement("iframe");
        iframe.src = "/settings";
        iframe.style.border = "none";
        iframe.style.width = "100%";
        iframe.style.flex = "1 1 auto";
        iframe.style.height = "100%";

        frameContainer.appendChild(closeBtn);
        frameContainer.appendChild(iframe);
        overlay.appendChild(frameContainer);
        document.body.appendChild(overlay);

        // Allow clicking outside the popup to close
        overlay.addEventListener("mousedown", function (e) {
          if (!frameContainer.contains(e.target)) {
            document.body.removeChild(overlay);
          }
        });
      };
      document.getElementById("clearHistoryBtn").onclick = function () {
        if (chatHistory.length > 0) {
          if (confirm("Are you sure you want to clear all chat history? This action cannot be undone.")) {
            chatHistory.length = 0; // Clear array
            chatMessages.innerHTML = ""; // Clear UI
            userInput.value = "";
            autoResize(userInput); // Reset textarea height
            userInput.focus();
          }
        } else {
          chatHistory.length = 0; // Clear array
          chatMessages.innerHTML = ""; // Clear UI
          userInput.value = "";
          autoResize(userInput); // Reset textarea height
          userInput.focus();
        }
      };

      // Focus input on page load
      window.addEventListener('load', function() {
        userInput.focus();
      });
    </script>
  </body>
</html>
