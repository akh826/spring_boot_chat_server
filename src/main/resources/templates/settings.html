<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings</title>
    <link rel="stylesheet" href="/css/general.css" />
    <link rel="stylesheet" href="/css/navigation.css" />
    <link rel="stylesheet" href="/css/settings.css" />
  </head>
  <body>
    <th:block th:replace="~{TopNav.html}"></th:block>
    
    <div class="content-wrapper">
      <div class="setting-container">
        <div class="setting-section">
          <label for="themeToggle">Theme</label>
          <div class="theme-selector">
            <button id="lightThemeBtn" class="btn theme-btn active">‚òÄÔ∏è Light</button>
            <button id="darkThemeBtn" class="btn theme-btn">üåô Dark</button>
          </div>
          <div class="setting-status" id="themeStatus">Theme saved!</div>
        </div>

        <hr class="setting-divider" />

        <div class="setting-section">
          <label for="apiKeyInput">DeepSeek API Key</label>
          <input
            id="apiKeyInput"
            type="password"
            placeholder="Enter your DeepSeek API Key"
          />
          <div class="btn-group">
            <button id="saveApiKeyBtn" class="btn">Save Key</button>
            <button id="clearApiKeyBtn" class="btn btn-danger">Clear Key</button>
          </div>
          <div class="setting-status" id="statusMsg">Saved!</div>
        </div>

        <hr class="setting-divider" />

        <div class="setting-section">
          <label for="systemPromptInput">System Prompt (Default)</label>
          <textarea
            id="systemPromptInput"
            placeholder="Set a default system prompt for DeepSeek chat"
            rows="3"
          ></textarea>
          <div class="btn-group">
            <button id="saveSystemPromptBtn" class="btn">Save Prompt</button>
            <button id="clearSystemPromptBtn" class="btn btn-danger">Clear Prompt</button>
          </div>
          <div class="setting-status" id="systemPromptStatus">Saved!</div>
        </div>

        <hr class="setting-divider" />

        <div class="setting-section">
          <label>Application Control</label>
          <div class="btn-group">
            <button id="hardRefreshBtn" class="btn btn-warning">üîÑ Hard Refresh</button>
          </div>
          <div class="setting-status" id="refreshStatus">Page refreshed!</div>
        </div>
      </div>
    </div>
    <script>
      // Theme Management
      const lightThemeBtn = document.getElementById("lightThemeBtn");
      const darkThemeBtn = document.getElementById("darkThemeBtn");
      const themeStatus = document.getElementById("themeStatus");

      // Load saved theme or default to light
      const savedTheme = localStorage.getItem("theme") || "light";
      applyTheme(savedTheme);

      function applyTheme(theme) {
        document.documentElement.setAttribute("data-theme", theme);
        
        // Update button states
        lightThemeBtn.classList.toggle("active", theme === "light");
        darkThemeBtn.classList.toggle("active", theme === "dark");
        
        // Save to localStorage
        localStorage.setItem("theme", theme);
        
        // Show status message
        showThemeStatus("Theme applied successfully!");
      }

      function showThemeStatus(message) {
        themeStatus.textContent = message;
        themeStatus.className = "setting-status success";
        setTimeout(() => {
          themeStatus.style.display = "none";
        }, 2000);
      }

      // Theme button event listeners
      lightThemeBtn.addEventListener("click", () => {
        applyTheme("light");
      });

      darkThemeBtn.addEventListener("click", () => {
        applyTheme("dark");
      });

      // API Key and System Prompt Management
      const apiKeyInput = document.getElementById("apiKeyInput");
      const saveApiKeyBtn = document.getElementById("saveApiKeyBtn");
      const clearApiKeyBtn = document.getElementById("clearApiKeyBtn");
      const statusMsg = document.getElementById("statusMsg");

      // System prompt elements
      const systemPromptInput = document.getElementById("systemPromptInput");
      const saveSystemPromptBtn = document.getElementById(
        "saveSystemPromptBtn"
      );
      const clearSystemPromptBtn = document.getElementById(
        "clearSystemPromptBtn"
      );
      const systemPromptStatus = document.getElementById("systemPromptStatus");

      // Load API key from localStorage if present
      const storedKey = localStorage.getItem("deepseek_api_key");
      if (storedKey) {
        apiKeyInput.value = storedKey;
      }

      // Load system prompt from localStorage if present
      const storedPrompt = localStorage.getItem("deepseek_system_prompt");
      if (storedPrompt) {
        systemPromptInput.value = storedPrompt;
      }

      saveApiKeyBtn.onclick = function () {
        localStorage.setItem("deepseek_api_key", apiKeyInput.value);
        statusMsg.textContent = "Saved!";
        statusMsg.style.color = "#28a745";
        statusMsg.style.display = "block";
        setTimeout(() => {
          statusMsg.style.display = "none";
        }, 1200);
      };
      clearApiKeyBtn.onclick = function () {
        localStorage.removeItem("deepseek_api_key");
        apiKeyInput.value = "";
        statusMsg.textContent = "Cleared!";
        statusMsg.style.color = "#dc3545";
        statusMsg.style.display = "block";
        setTimeout(() => {
          statusMsg.style.display = "none";
        }, 1200);
      };

      saveSystemPromptBtn.onclick = function () {
        localStorage.setItem("deepseek_system_prompt", systemPromptInput.value);
        systemPromptStatus.textContent = "Saved!";
        systemPromptStatus.style.color = "#28a745";
        systemPromptStatus.style.display = "block";
        setTimeout(() => {
          systemPromptStatus.style.display = "none";
        }, 1200);
      };
      clearSystemPromptBtn.onclick = function () {
        localStorage.removeItem("deepseek_system_prompt");
        systemPromptInput.value = "";
        systemPromptStatus.textContent = "Cleared!";
        systemPromptStatus.style.color = "#dc3545";
        systemPromptStatus.style.display = "block";
        setTimeout(() => {
          systemPromptStatus.style.display = "none";
        }, 1200);
      };

      // Theme management using global ThemeManager
      const lightBtn = document.getElementById('lightTheme');
      const darkBtn = document.getElementById('darkTheme');
      const statusElement = document.getElementById('themeStatus');
      
      // Update UI based on current theme
      function updateThemeUI() {
          const currentTheme = window.ThemeManager.getCurrentTheme();
          
          lightBtn.classList.toggle('active', currentTheme === 'light');
          darkBtn.classList.toggle('active', currentTheme === 'dark');
          
          statusElement.textContent = `Current theme: ${currentTheme}`;
      }
      
      // Set up event listeners
      lightBtn.addEventListener('click', function() {
          window.ThemeManager.applyTheme('light');
          localStorage.setItem('theme', 'light');
          updateThemeUI();
      });
      
      darkBtn.addEventListener('click', function() {
          window.ThemeManager.applyTheme('dark');
          localStorage.setItem('theme', 'dark');
          updateThemeUI();
      });
      
      // Listen for theme changes from other sources
      window.addEventListener('themeChanged', updateThemeUI);
      
      // Initialize UI
      updateThemeUI();

      // Hard Refresh Button
      const hardRefreshBtn = document.getElementById("hardRefreshBtn");
      const refreshStatus = document.getElementById("refreshStatus");

      hardRefreshBtn.addEventListener("click", function() {
        // Show status message
        refreshStatus.textContent = "Performing hard refresh...";
        refreshStatus.style.color = "#ffc107";
        refreshStatus.style.display = "block";
        
        // Perform hard refresh after a short delay to show the message
        setTimeout(() => {
          // Clear browser cache and reload
          if ('caches' in window) {
            caches.keys().then(function(names) {
              for (let name of names) {
                caches.delete(name);
              }
            });
          }
          
          // Force reload with cache bypass
          window.location.reload(true);
        }, 500);
      });
    </script>
  </body>
</html>
